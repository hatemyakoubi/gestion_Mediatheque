<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Médiathèque - Gestion des Abonnés</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Médiathèque</h1>
            <div class="space-x-4">
                <a href="#" class="hover:text-gray-200" onclick="showSection('subscribers')">Abonnés</a>
                <a href="#" class="hover:text-gray-200" onclick="showSection('documents')">Documents</a>
                <a href="#" class="hover:text-gray-200" onclick="showSection('loans')">Emprunts</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <!-- Subscribers Section -->
        <section id="subscribers" class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Abonnés</h2>
                <button onclick="showModal('subscriberForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouvel Abonné
                </button>
                <!-- Modal -->
                <div id="subscriberFormModal"
                    class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden">
                    <div id="subscriberModalContent" class="bg-white p-6 rounded shadow-lg w-1/3">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">First Name</th>
                            <th class="text-left p-2">Last Name</th>
                            <th class="text-left p-2">Role</th>
                            <th class="text-left p-2">phone</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subscribersList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
            <!--Subscribe Edit modal -->
            <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
                <div class="bg-white rounded-lg p-4 max-w-lg mx-auto mt-20">
                    <span onclick="closeEditSubscribeModal()" class="close"
                        style="cursor: pointer; float: right;">&times;</span>
                    <h2 class="text-lg font-bold mb-4">Edit Subscriber</h2>
                    <form class="space-y-4">
                        <div>
                            <label for="subscriberFirstName" class="block font-medium text-gray-700">First Name</label>
                            <input type="text" id="editFirstName" name="firstName"
                                class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div>
                            <label for="subscriberLastName" class="block font-medium text-gray-700">Last Name</label>
                            <input type="text" id="editLastName" name="lastName" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div>
                            <label for="subscriberEmail" class="block font-medium text-gray-700">Email</label>
                            <input type="email" id="editEmail" name="email" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div>
                            <label for="subscriberAdress" class="block font-medium text-gray-700">Adress</label>
                            <input type="text" id="editAddress" name="address" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div>
                            <label for="subscriberPhone" class="block font-medium text-gray-700">Phone</label>
                            <input type="text" id="editPhone" name="phone" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2"
                                onclick="closeEditSubscribeModal()">Annuler</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded"
                                id="editSubscriberButton">Edit</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Documents Section -->
        <section id="documents" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Documents</h2>
                <button onclick="showModal('documentForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouveau Document
                </button>
            </div>
            <!-- Document List -->
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">Titre</th>
                            <th class="text-left p-2">Auteur</th>
                            <th class="text-left p-2">Type</th>
                            <th class="text-left p-2">Genre</th>
                            <th class="text-left p-2">D.Publication</th>
                            <th class="text-left p-2">Disponibilité</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
                <div id="documentPagination" class="mt-4 flex justify-center space-x-2">
                    <!-- Pagination controls will be added here -->
                </div>
            </div>

            <div id="documentFormModal"
                class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden">
                <div id="documentModalContent" class="bg-white p-6 rounded shadow-lg w-1/3">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>

            <!-- Document Edit Modal -->
            <div id="editDocumentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
                <div class="bg-white rounded-lg p-4 max-w-lg mx-auto mt-20">
                    <h2 class="text-lg font-bold mb-4">Edit Document</h2>
                    <form class="space-y-4">
                        <div>
                            <label class="block font-medium text-gray-700">Titre</label>
                            <input type="text" id="editDocTitle" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Auteur</label>
                            <input type="text" id="editDocAuthor" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Type</label>
                            <select id="editDocType" class="w-full border rounded px-3 py-2">
                                <option value="book">Livre</option>
                                <option value="magazine">Magazine</option>
                                <option value="cd">CD</option>
                                <option value="dvd">DVD</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">ISBN</label>
                            <input type="text" id="editDocISBN" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Genre</label>
                            <input type="text" id="editDocGenre" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Année de publication</label>
                            <input type="number" id="editDocYear" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeEditDocumentModal()"
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Annuler</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded"
                                id="editDocumentButton">Mettre à jour</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>


        <!-- Loans Section -->
        <section id="loans" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Emprunts</h2>
                <button onclick="showModal('loanForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouvel Emprunt
                </button>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">Abonné</th>
                            <th class="text-left p-2">Document</th>
                            <th class="text-left p-2">Date d'emprunt</th>
                            <th class="text-left p-2">Date de retour prévue</th>
                            <th class="text-left p-2">Statut</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loansList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Loan Form Modal -->
            <div id="loanFormModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
                <div class="bg-white rounded-lg p-4 max-w-lg mx-auto mt-20">
                    <h2 class="text-lg font-bold mb-4">Nouvel Emprunt</h2>
                    <form id="newLoanForm" class="space-y-4">
                        <div>
                            <label class="block font-medium text-gray-700">Abonné</label>
                            <select id="loanSubscriber" class="w-full border rounded px-3 py-2" required>
                                <!-- Filled dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Document</label>
                            <select id="loanDocument" class="w-full border rounded px-3 py-2" required>
                                <!-- Filled dynamically -->
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeLoanModal()"
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Annuler</button>
                            <button type="button" onclick="createLoan()"
                                class="bg-blue-500 text-white px-4 py-2 rounded">Créer</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal Templates -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg p-4 max-w-lg mx-auto mt-20">
            <!-- Modal content will be injected here -->
        </div>
    </div>
    <!-- Subscriber Details Modal -->
    <div id="subscriberDetailsModal" class="hidden fixed inset-0 z-50 flex justify-center items-center">
        <div class="modal-content bg-white p-4 rounded-md shadow-lg relative">
            <!-- Close button (X) -->
            <button onclick="closeSubscriberDetailModal()"
                class="absolute top-2 right-2 text-red-500 text-xl font-bold">&times;</button>

            <!-- Modal content goes here -->
            <div id="subscriberDetailsContent">
                <!-- Dynamic subscriber details will be populated here -->
            </div>
        </div>
    </div>

    <script>

        // Function to show a modal and dynamically inject a form based on the formId
        function showModalSubscriberForm(modalContent) {
            // Clear any existing content in the modal
            modalContent.innerHTML = '';

            // Dynamically inject the form based on formId
            modalContent.innerHTML = `
            <h2 class="text-lg font-bold mb-4">New subscriber</h2>
            <form id="createSubscriberForm" class="space-y-4 method="POST">
                <div>
                    <label for="subscriberFirstName" class="block font-medium text-gray-700">First Name</label>
                    <input type="text" id="subscriberFirstName" name="subscriberFirstName" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberLastName" class="block font-medium text-gray-700">Last Name</label>
                    <input type="text" id="subscriberLastName" name="subscriberLastName" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberEmail" class="block font-medium text-gray-700">Email</label>
                    <input type="email" id="subscriberEmail" name="subscriberEmail" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberAdress" class="block font-medium text-gray-700">Adress</label>
                    <input type="text" id="subscriberAdress" name="subscriberAdress" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberPhone" class="block font-medium text-gray-700">Phone</label>
                    <input type="text" id="subscriberPhone" name="subscriberPhone" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2" onclick="closeInsertSubscriberModal()">Annuler</button>
                    <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="submitSubscriberForm()">Créer</button>

                </div>
            </form>
        `;

        }

        function submitSubscriberForm() {
            const form = document.getElementById('createSubscriberForm');

            // Collect form data
            const subscriberData = {
                first_name: form.subscriberFirstName.value,
                last_name: form.subscriberLastName.value,
                email: form.subscriberEmail.value,
                address: form.subscriberAdress.value,
                phone: form.subscriberPhone.value,
            };

            // Send a POST request to the server
            fetch('/api/subscribers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(subscriberData),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Failed to add subscriber');
                    }
                    return response.json();
                })
                .then((data) => {
                    Swal.fire({
                        title: '<strong>Success!</strong>',
                        icon: 'success',
                        html: `Subscriber added successfully with ID <b>${data.id}</b>.`,
                        timer: 3000,
                        timerProgressBar: true,
                    });

                    closeInsertSubscriberModal(); // Close the modal after success
                    fetchSubscribers();
                })
                .catch((error) => {
                    alert(`Error: ${error.message}`);
                });
        }
        // Function to hide the modal
        function closeInsertSubscriberModal() {
            const modal = document.getElementById('subscriberFormModal');
            modal.classList.add('hidden');
        }
        function closeInsertDocumentModal() {
            const modal = document.getElementById('documentFormModal');
            modal.classList.add('hidden');
        }


        // API calls
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        async function loadSectionData(section) {
            switch (section) {
                case 'subscribers':
                    const subscribers = await fetchData('subscribers');
                    renderSubscribers(subscribers);  // Call renderSubscribers
                    break;
                case 'documents':
                    const documents = await fetchData('documents');
                    fetchDocuments(1);  // Fetch the first page of documents

                    renderDocuments(documents);
                    break;
                case 'loans':
                    const loans = await fetchData('loans');
                    renderLoans(loans);
                    break;
            }
        }

        // Render Subscribers data
        function renderSubscribers(subscribers) {
            const subscribersList = document.getElementById('subscribersList');
            subscribersList.innerHTML = '';  // Clear existing content

            if (subscribers && subscribers.length > 0) {
                subscribers.forEach(subscriber => {
                    const row = document.createElement('tr');

                    const nameCell = document.createElement('td');
                    nameCell.classList.add('p-2');
                    nameCell.textContent = subscriber.first_name;
                    row.appendChild(nameCell);

                    const firstNameCell = document.createElement('td');
                    firstNameCell.classList.add('p-2');
                    firstNameCell.textContent = subscriber.last_name;
                    row.appendChild(firstNameCell);

                    const lastNameCell = document.createElement('td');
                    lastNameCell.classList.add('p-2');
                    lastNameCell.textContent = subscriber.phone;
                    row.appendChild(lastNameCell);

                    const emailCell = document.createElement('td');
                    emailCell.classList.add('p-2');
                    emailCell.textContent = subscriber.email;
                    row.appendChild(emailCell);

                    const actionsCell = document.createElement('td');
                    actionsCell.classList.add('p-2');
                    actionsCell.innerHTML = `
                <button onclick="openEditModal('${subscriber._id}')" class="bg-yellow-500 text-white px-4 py-2 rounded">Edit</button>
                <button class="bg-red-500 text-white px-4 py-2 rounded" onclick="deleteSubscriber('${subscriber._id}')">Delete</button>
                <button onclick="showSubscriberDetails(${JSON.stringify(subscriber).replace(/"/g, '&quot;')})" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Details
                </button>
            `;
                    row.appendChild(actionsCell);

                    subscribersList.appendChild(row);
                });
            } else {
                subscribersList.innerHTML = '<tr><td colspan="4" class="p-2 text-center">No subscribers found</td></tr>';
            }
        }


        // Function to display subscriber details
        function showSubscriberDetails(subscriber) {
            const modal = document.getElementById('subscriberDetailsModal');
            const content = document.getElementById('subscriberDetailsContent');

            // Format the current loans into a readable format
            let currentLoansHtml = '';
            subscriber.current_loans.forEach(loan => {
                currentLoansHtml += `
            <div class="border-b py-2">
                <p><strong>Document ID:</strong> ${loan.document_id}</p>
                <p><strong>Loan Date:</strong> ${new Date(loan.loan_date).toLocaleString()}</p>
                <p><strong>Due Date:</strong> ${new Date(loan.due_date).toLocaleString()}</p>
                <p><strong>Status:</strong> ${loan.status}</p>
            </div>
        `;
            });

            // Populate the modal with subscriber details
            content.innerHTML = `
        <p><strong>Nom:</strong> ${subscriber.last_name}</p>
        <p><strong>Prénom:</strong> ${subscriber.first_name}</p>
        <p><strong>Email:</strong> ${subscriber.email}</p>
        <p><strong>Adresse:</strong> ${subscriber.address}</p>
        <p><strong>Téléphone:</strong> ${subscriber.phone}</p>
        <p><strong>Date d'inscription:</strong> ${new Date(subscriber.inscription_date).toLocaleDateString()}</p>
        
        <h4 class="font-bold mt-4">Emprunts Actuels:</h4>
        ${currentLoansHtml ? currentLoansHtml : '<p>Aucun emprunt actuel.</p>'}
        
        <h4 class="font-bold mt-4">Historique des Emprunts:</h4>
        ${subscriber.loan_history.length > 0 ? subscriber.loan_history.map(loan => {
                return `
                <div class="border-b py-2">
                    <p><strong>Document ID:</strong> ${loan.document_id}</p>
                    <p><strong>Loan Date:</strong> ${new Date(loan.loan_date).toLocaleString()}</p>
                    <p><strong>Due Date:</strong> ${new Date(loan.due_date).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${loan.status}</p>
                </div>
            `;
            }).join('') : '<p>Aucun historique d\'emprunts.</p>'}
    `;

            // Show the modal
            modal.classList.remove('hidden');
        }


        function deleteSubscriber(subscriberId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Perform the delete request
                    fetch(`/api/subscribers/${subscriberId}`, {
                        method: 'DELETE',
                    })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire(
                                    'Deleted!',
                                    'The subscriber has been deleted.',
                                    'success'
                                );
                                fetchSubscribers(); // Refresh the list after deletion
                            } else {
                                response.json().then(data => {
                                    Swal.fire(
                                        'Error!',
                                        data.message || 'Failed to delete the subscriber.',
                                        'error'
                                    );
                                });
                            }
                        })
                        .catch(error => {
                            console.error("Error deleting subscriber:", error);
                            Swal.fire(
                                'Error!',
                                'An error occurred while deleting the subscriber.',
                                'error'
                            );
                        });
                }
            });
        }


        function fetchSubscribers() {
            fetch('/api/subscribers/')
                .then(response => response.json())
                .then(data => {
                    renderSubscribers(data);
                })
                .catch(error => {
                    console.error("Error fetching subscribers:", error);
                    alert("Failed to load subscribers");
                });
        }


        function openEditModal(id) {
            console.log(`Opening edit modal for subscriber ID: ${id}`);

            // Fetch subscriber details by ID
            fetch(`/api/subscribers/${id}`)
                .then(response => response.json())
                .then(subscriber => {
                    console.log('Subscriber data:', subscriber);

                    // Show the modal
                    const modal = document.getElementById('editModal');
                    modal.style.display = 'block'; // Ensure this works
                    console.log('Modal display set to block');

                    // Populate the form with subscriber data
                    document.getElementById('editFirstName').value = subscriber.first_name;
                    document.getElementById('editLastName').value = subscriber.last_name;
                    document.getElementById('editEmail').value = subscriber.email;
                    document.getElementById('editAddress').value = subscriber.address;
                    document.getElementById('editPhone').value = subscriber.phone;

                    console.log('Form fields populated');

                    // Attach event listener to the "Edit" button
                    const editButton = document.getElementById('editSubscriberButton');
                    editButton.onclick = function () {
                        const updatedSubscriber = {
                            first_name: document.getElementById('editFirstName').value,
                            last_name: document.getElementById('editLastName').value,
                            email: document.getElementById('editEmail').value,
                            address: document.getElementById('editAddress').value,
                            phone: document.getElementById('editPhone').value,
                        };
                        fetch(`/api/subscribers/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedSubscriber),
                        })
                            .then(response => response.json())
                            .then(data => {
                                Swal.fire({
                                    title: 'Success!',
                                    text: 'Subscriber updated successfully.',
                                    icon: 'success',
                                    timer: 3000,
                                    timerProgressBar: true,
                                });
                                // Close modal and reload subscribers list
                                modal.style.display = 'none';
                                fetchSubscribers();
                            })
                            .catch(error => {
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'Failed to update subscriber.',
                                    icon: 'error',
                                });
                                console.error('Error updating subscriber:', error);
                            });
                    };

                })
                .catch(error => {
                    console.error('Error fetching subscriber:', error);
                });
        }


        // Close modal on Cancel
        function closeEditSubscribeModal() {
            const modal = document.getElementById('editModal');
            modal.style.display = 'none';
        }

        // Document Management Functions
        async function loadDocuments(page = 1) {
            try {
                const response = await fetch(`/api/documents?page=${page}&per_page=10`);
                if (!response.ok) {
                    throw new Error('Failed to fetch documents');
                }

                const data = await response.json();
                renderDocuments(data.documents);
                renderPagination(data.pagination);
            } catch (error) {
                console.error('Error loading documents:', error);
                Swal.fire('Error', 'Failed to load documents', 'error');
            }
        }

        function renderDocuments(documents) {
            const tbody = document.getElementById('documentsList');
            tbody.innerHTML = '';

            if (!documents || documents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No documents found</td></tr>';
                return;
            }

            documents.forEach(doc => {
                tbody.innerHTML += `
            <tr>
                <td class="p-2">${doc.title || ''}</td>
                <td class="p-2">${doc.author || ''}</td>
                <td class="p-2">${doc.type || ''}</td>
                <td class="p-2">${doc.genre || '-'}</td>
                <td class="p-2">${doc.publication_date || ''}</td>
                <td class="p-2">
                    <span class="px-2 py-1 rounded ${doc.available ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                        ${doc.available ? 'Disponible' : 'Emprunté'}
                    </span>
                </td>
                <td class="p-2 space-x-2">
                    <button onclick="openEditDocumentModal('${doc._id}')" class="bg-yellow-500 text-white px-3 py-1 rounded">
                        Modifier
                    </button>
                    <button onclick="deleteDocument('${doc._id}')" class="bg-red-500 text-white px-3 py-1 rounded">
                        Supprimer
                    </button>
                </td>
            </tr>
        `;
            });
        }

        function renderPagination(pagination) {
            const container = document.getElementById('documentPagination');
            const currentPage = pagination.page;
            const totalPages = pagination.total_pages;

            let html = '<div class="flex justify-center space-x-2">';

            // Previous button
            if (currentPage > 1) {
                html += `
            <button onclick="loadDocuments(${currentPage - 1})" 
                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                Previous
            </button>
        `;
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `
                <button class="px-3 py-1 bg-blue-700 text-white rounded" disabled>
                    ${i}
                </button>
            `;
                } else {
                    html += `
                <button onclick="loadDocuments(${i})" 
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                    ${i}
                </button>
            `;
                }
            }

            // Next button
            if (currentPage < totalPages) {
                html += `
            <button onclick="loadDocuments(${currentPage + 1})" 
                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                Next
            </button>
        `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        async function createDocument(data) {
            try {
                const response = await fetch('/api/documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create document');

                Swal.fire('Success', 'Document created successfully', 'success');
                loadDocuments();
                closeModal();
            } catch (error) {
                console.error('Error creating document:', error);
                Swal.fire('Error', 'Failed to create document', 'error');
            }
        }

        async function updateDocument() {
            const docId = document.getElementById('editDocumentForm').dataset.docId;
            const data = {
                title: document.getElementById('editDocTitle').value,
                author: document.getElementById('editDocAuthor').value,
                type: document.getElementById('editDocType').value,
                isbn: document.getElementById('editDocISBN').value,
                publication_date: document.getElementById('editDocYear').value
            };

            try {
                const response = await fetch(`/api/documents/${docId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to update document');

                Swal.fire('Success', 'Document updated successfully', 'success');
                loadDocuments();
                closeEditDocumentModal();
            } catch (error) {
                console.error('Error updating document:', error);
                Swal.fire('Error', 'Failed to update document', 'error');
            }
        }

        async function deleteDocument(docId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/api/documents/${docId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error('Failed to delete document');

                    Swal.fire('Deleted!', 'Document has been deleted.', 'success');
                    loadDocuments();
                } catch (error) {
                    console.error('Error deleting document:', error);
                    Swal.fire('Error', 'Failed to delete document', 'error');
                }
            }
        }

        async function openEditDocumentModal(id) {
            try {
                const response = await fetch(`/api/documents/${id}`);
                const doc = await response.json();

                // Show the modal
                const modal = document.getElementById('editDocumentModal');
                modal.style.display = 'block'; // Ensure this works
                console.log('Modal display set to block');

                document.getElementById('editDocTitle').value = doc.title;
                document.getElementById('editDocAuthor').value = doc.author;
                document.getElementById('editDocType').value = doc.type;
                document.getElementById('editDocISBN').value = doc.isbn || '';
                document.getElementById('editDocGenre').value = doc.genre || '';
                document.getElementById('editDocYear').value = doc.publication_date || '';

                //document.getElementById('editDocumentModal').classList.remove('hidden');
                // Attach event listener to the "Edit" button
                const editButton = document.getElementById('editDocumentButton');
                editButton.onclick = function () {
                    const updatedDocument = {
                        title: document.getElementById('editDocTitle').value,
                        author: document.getElementById('editDocAuthor').value,
                        type: document.getElementById('editDocType').value,
                        isbn: document.getElementById('editDocISBN').value,
                        genre: document.getElementById('editDocGenre').value,
                        publication_date: document.getElementById('editDocYear').value
                    };
                    fetch(`/api/documents/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedDocument),
                    })
                        .then(response => response.json())
                        .then(data => {
                            Swal.fire({
                                title: 'Success!',
                                text: 'Document updated successfully.',
                                icon: 'success',
                                timer: 3000,
                                timerProgressBar: true,
                            });
                            // Close modal and reload subscribers list
                            modal.style.display = 'none';
                            loadDocuments();

                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'Error!',
                                text: 'Failed to update document.',
                                icon: 'error',
                            });
                            console.error('Error updating document:', error);
                        });
                };
            } catch (error) {
                console.error('Error fetching document:', error);
                Swal.fire('Error', 'Failed to load document details', 'error');
            }
        }
       
       
        // Loan Management Functions
       
        async function loadLoans() {
            try {
                const response = await fetch('/api/loans');
                const loans = await response.json();
                renderLoans(loans);
            } catch (error) {
                console.error('Error loading loans:', error);
                Swal.fire('Error', 'Failed to load loans', 'error');
            }
        }

        function renderLoans(loans) {
            const tbody = document.getElementById('loansList');
            tbody.innerHTML = '';

            loans.forEach(loan => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${loan.subscriber_name}</td>
                    <td class="p-2">${loan.document_title}</td>
                    <td class="p-2">${new Date(loan.loan_date).toLocaleDateString()}</td>
                    <td class="p-2">${new Date(loan.due_date).toLocaleDateString()}</td>
                    <td class="p-2">
                        <span class="px-2 py-1 rounded ${loan.status === 'active' ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'}">
                            ${loan.status === 'active' ? 'En cours' : 'Retourné'}
                        </span>
                    </td>
                    <td class="p-2 space-x-2">
                        ${loan.status === 'active' ? `
                            <button onclick="returnLoan('${loan._id}')" class="bg-blue-500 text-white px-3 py-1 rounded">
                                Retourner
                            </button>
                        ` : ''}
                        <button onclick="deleteLoan('${loan._id}')" class="bg-red-500 text-white px-3 py-1 rounded">
                            Supprimer
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadLoanFormData() {
            try {
                // Load subscribers
                const subscribersResponse = await fetch('/api/subscribers');
                const subscribers = await subscribersResponse.json();
                const subscriberSelect = document.getElementById('loanSubscriber');
                subscriberSelect.innerHTML = '<option value="">Sélectionner un abonné</option>';
                subscribers.forEach(sub => {
                    subscriberSelect.innerHTML += `<option value="${sub._id}">${sub.first_name} ${sub.last_name}</option>`;
                });

                // Load available documents
                const documentsResponse = await fetch('/api/documents');
                const documentsData = await documentsResponse.json();
                const documents = documentsData.documents;
                const documentSelect = document.getElementById('loanDocument');
                documentSelect.innerHTML = '<option value="">Sélectionner un document</option>';
                documents.filter(doc => doc.available).forEach(doc => {
                    documentSelect.innerHTML += `<option value="${doc._id}">${doc.title} (${doc.type})</option>`;
                });
            } catch (error) {
                console.error('Error loading form data:', error);
                Swal.fire('Error', 'Failed to load form data', 'error');
            }
        }

        async function createLoan() {
            const subscriberId = document.getElementById('loanSubscriber').value;
            const documentId = document.getElementById('loanDocument').value;

            if (!subscriberId || !documentId) {
                Swal.fire('Error', 'Please select both subscriber and document', 'error');
                return;
            }

            try {
                const response = await fetch('/api/loans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscriber_id: subscriberId,
                        document_id: documentId
                    })
                });

                if (!response.ok) throw new Error('Failed to create loan');

                Swal.fire('Success', 'Loan created successfully', 'success');
                closeLoanModal();
                loadLoans();
            } catch (error) {
                console.error('Error creating loan:', error);
                Swal.fire('Error', 'Failed to create loan', 'error');
            }
        }

        async function returnLoan(loanId) {
            try {
                const response = await fetch(`/api/loans/${loanId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'returned' })
                });

                if (!response.ok) throw new Error('Failed to return loan');

                Swal.fire('Success', 'Document returned successfully', 'success');
                loadLoans();
            } catch (error) {
                console.error('Error returning loan:', error);
                Swal.fire('Error', 'Failed to return loan', 'error');
            }
        }

        async function deleteLoan(loanId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/api/loans/${loanId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error('Failed to delete loan');

                    Swal.fire('Deleted!', 'Loan has been deleted.', 'success');
                    loadLoans();
                } catch (error) {
                    console.error('Error deleting loan:', error);
                    Swal.fire('Error', 'Failed to delete loan', 'error');
                }
            }
        }

        // Modal functions
        function showModal(formType) {
            switch (formType) {
                case 'subscriberForm':
                    const subscriberModal = document.getElementById('subscriberFormModal');
                    const subscriberContent = document.getElementById('subscriberModalContent');
                    subscriberModal.classList.remove('hidden');
                    showModalSubscriberForm(subscriberContent);
                    break;
                case 'documentForm':
                    const documentModal = document.getElementById('documentFormModal');
                    const documentContent = document.getElementById('documentModalContent');
                    documentModal.classList.remove('hidden');
                    showDocumentForm(documentContent);
                    break;
                case 'loanForm':
                    const loanModal = document.getElementById('loanFormModal');
                    loanModal.classList.remove('hidden');
                    showLoanForm();
                    break;
            }
        }


        function showDocumentForm(modalContent) {
            modalContent.innerHTML = `
        <h2 class="text-lg font-bold mb-4">Nouveau Document</h2>
        <form id="newDocumentForm" class="space-y-4">
            <div>
                <label class="block font-medium text-gray-700">Titre</label>
                <input type="text" id="docTitle" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block font-medium text-gray-700">Auteur</label>
                <input type="text" id="docAuthor" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block font-medium text-gray-700">Type</label>
                <select id="docType" class="w-full border rounded px-3 py-2">
                    <option value="book">Livre</option>
                    <option value="magazine">Magazine</option>
                    <option value="cd">CD</option>
                    <option value="dvd">DVD</option>
                </select>
            </div>
            <div>
                <label class="block font-medium text-gray-700">ISBN</label>
                <input type="text" id="docISBN" class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block font-medium text-gray-700">Genre</label>
                <input type="text" id="genre" class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block font-medium text-gray-700">Année de publication</label>
                <input type="number" id="docYear" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeInsertDocumentModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Annuler</button>
                <button type="button" onclick="submitDocument()" class="bg-blue-500 text-white px-4 py-2 rounded">Créer</button>
            </div>
        </form>
    `;
        }
        // Add the submit document function
        async function submitDocument() {
            const documentData = {
                title: document.getElementById('docTitle').value,
                author: document.getElementById('docAuthor').value,
                type: document.getElementById('docType').value,
                isbn: document.getElementById('docISBN').value,
                genre: document.getElementById('genre').value,
                publication_date: document.getElementById('docYear').value,
            };

            try {
                const response = await fetch('/api/documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(documentData)
                });

                if (!response.ok) {
                    throw new Error('Failed to create document');
                }

                const result = await response.json();
                Swal.fire({
                    title: 'Success!',
                    text: 'Document created successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

                closeInsertDocumentModal();
                loadDocuments(1); // Refresh the documents list
            } catch (error) {
                console.error('Error creating document:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to create document',
                    icon: 'error'
                });
            }
        }


        function showLoanForm() {
            const modalContent = document.querySelector('#modal > div');
            modalContent.innerHTML = `
                <h2 class="text-lg font-bold mb-4">Nouvel Emprunt</h2>
                <form id="newLoanForm" class="space-y-4">
                    <div>
                        <label class="block font-medium text-gray-700">Abonné</label>
                        <select id="loanSubscriber" class="w-full border rounded px-3 py-2" required>
                            <option value="">Sélectionner un abonné</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-medium text-gray-700">Document</label>
                        <select id="loanDocument" class="w-full border rounded px-3 py-2" required>
                            <option value="">Sélectionner un document</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Annuler</button>
                        <button type="button" onclick="createLoan()" class="bg-blue-500 text-white px-4 py-2 rounded">Créer</button>
                    </div>
                </form>
            `;
            loadLoanFormData();
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function closeEditDocumentModal() {
            const modal = document.getElementById('editDocumentModal');
            modal.classList.add('hidden');
        }

        function closeSubscriberDetailModal() {
            document.getElementById('subscriberDetailsModal').classList.add('hidden');
        }


        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            showSection('subscribers');
        });

        function showSection(sectionId) {
            document.querySelectorAll('main section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            switch (sectionId) {
                case 'subscribers':
                    fetchSubscribers();
                    break;
                case 'documents':
                    loadDocuments(1);
                    break;
                case 'loans':
                    loadLoans();
                    break;
            }
        }
    </script>
</body>

</html>