<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Médiathèque - Gestion des Abonnés</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Médiathèque</h1>
            <div class="space-x-4">
                <a href="#" class="hover:text-gray-200" onclick="showSection('subscribers')">Abonnés</a>
                <a href="#" class="hover:text-gray-200" onclick="showSection('documents')">Documents</a>
                <a href="#" class="hover:text-gray-200" onclick="showSection('loans')">Emprunts</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <!-- Subscribers Section -->
        <section id="subscribers" class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Abonnés</h2>
                <button onclick="showModal('subscriberForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouvel Abonné
                </button>
                <!-- Modal -->
                <div id="modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden">
                    <div id="modalContent" class="bg-white p-6 rounded shadow-lg w-1/3">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">First Name</th>
                            <th class="text-left p-2">Last Name</th>
                            <th class="text-left p-2">Role</th>
                            <th class="text-left p-2">phone</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subscribersList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
            <!--Subscribe Edit modal -->
            <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
                <div class="bg-white rounded-lg p-4 max-w-lg mx-auto mt-20">
                    <span onclick="closeEditSubscribeModal()" class="close"
                        style="cursor: pointer; float: right;">&times;</span>
                    <h2 class="text-lg font-bold mb-4">Edit Subscriber</h2>
                    <form class="space-y-4">
                        <div>
                            <label for="subscriberFirstName" class="block font-medium text-gray-700">First Name</label>
                            <input type="text" id="editFirstName" name="firstName"
                                class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div>
                            <label for="subscriberLastName" class="block font-medium text-gray-700">Last Name</label>
                            <input type="text" id="editLastName" name="lastName" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div>
                            <label for="subscriberEmail" class="block font-medium text-gray-700">Email</label>
                            <input type="email" id="editEmail" name="email" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div>
                            <label for="subscriberAdress" class="block font-medium text-gray-700">Adress</label>
                            <input type="text" id="editAddress" name="address" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div>
                            <label for="subscriberPhone" class="block font-medium text-gray-700">Phone</label>
                            <input type="text" id="editPhone" name="phone" class="w-full border rounded px-3 py-2"
                                required>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2"
                                onclick="closeEditSubscribeModal()">Annuler</button>
                            <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded"
                                id="editSubscriberButton">Edit</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Documents Section -->
        <section id="documents" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Documents</h2>
                <button onclick="showModal('documentForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouveau Document
                </button>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">Titre</th>
                            <th class="text-left p-2">Auteur</th>
                            <th class="text-left p-2">Type</th>
                            <th class="text-left p-2">Disponibilité</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
            <div id="pagination" class="mt-4 flex justify-center space-x-2">
                <button id="prevPage" onclick="fetchDocuments(currentPage - 1)" class="bg-blue-500 text-white px-4 py-2 rounded" disabled>Previous</button>
                <button id="nextPage" onclick="fetchDocuments(currentPage + 1)" class="bg-blue-500 text-white px-4 py-2 rounded">Next</button>
            </div>

        </section>

        <!-- Loans Section -->
        <section id="loans" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Emprunts</h2>
                <button onclick="showModal('loanForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouvel Emprunt
                </button>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">Abonné</th>
                            <th class="text-left p-2">Document</th>
                            <th class="text-left p-2">Date d'emprunt</th>
                            <th class="text-left p-2">Date de retour</th>
                            <th class="text-left p-2">Status</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loansList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
        </section>


    </main>

    <!-- Modal Templates -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg p-4 max-w-lg mx-auto mt-20">
            <!-- Modal content will be injected here -->
        </div>
    </div>
    <!-- Subscriber Details Modal -->
    <div id="subscriberDetailsModal" class="hidden fixed inset-0 z-50 flex justify-center items-center">
        <div class="modal-content bg-white p-4 rounded-md shadow-lg relative">
            <!-- Close button (X) -->
            <button onclick="closeModal()"
                class="absolute top-2 right-2 text-red-500 text-xl font-bold">&times;</button>

            <!-- Modal content goes here -->
            <div id="subscriberDetailsContent">
                <!-- Dynamic subscriber details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        function showSection(sectionId) {
            document.querySelectorAll('main section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            loadSectionData(sectionId);
        }

        // Function to show a modal and dynamically inject a form based on the formId
        function showModal(formId) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent'); // Ensure this element exists in your modal
            modal.classList.remove('hidden');

            // Clear any existing content in the modal
            modalContent.innerHTML = '';

            // Dynamically inject the form based on formId
            if (formId === 'subscriberForm') {
                modalContent.innerHTML = `
            <h2 class="text-lg font-bold mb-4">New subscriber</h2>
            <form id="createSubscriberForm" class="space-y-4 method="POST">
                <div>
                    <label for="subscriberFirstName" class="block font-medium text-gray-700">First Name</label>
                    <input type="text" id="subscriberFirstName" name="subscriberFirstName" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberLastName" class="block font-medium text-gray-700">Last Name</label>
                    <input type="text" id="subscriberLastName" name="subscriberLastName" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberEmail" class="block font-medium text-gray-700">Email</label>
                    <input type="email" id="subscriberEmail" name="subscriberEmail" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberAdress" class="block font-medium text-gray-700">Adress</label>
                    <input type="text" id="subscriberAdress" name="subscriberAdress" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="subscriberPhone" class="block font-medium text-gray-700">Phone</label>
                    <input type="text" id="subscriberPhone" name="subscriberPhone" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2" onclick="closeInsertSubscriberModal()">Annuler</button>
                    <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="submitSubscriberForm()">Créer</button>

                </div>
            </form>
        `;
            }
        }

        function submitSubscriberForm() {
            const form = document.getElementById('createSubscriberForm');

            // Collect form data
            const subscriberData = {
                first_name: form.subscriberFirstName.value,
                last_name: form.subscriberLastName.value,
                email: form.subscriberEmail.value,
                address: form.subscriberAdress.value,
                phone: form.subscriberPhone.value,
            };

            // Send a POST request to the server
            fetch('/api/subscribers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(subscriberData),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Failed to add subscriber');
                    }
                    return response.json();
                })
                .then((data) => {
                    Swal.fire({
                        title: '<strong>Success!</strong>',
                        icon: 'success',
                        html: `Subscriber added successfully with ID <b>${data.id}</b>.`,
                        timer: 3000,
                        timerProgressBar: true,
                    });

                    closeInsertSubscriberModal(); // Close the modal after success
                    fetchSubscribers();
                })
                .catch((error) => {
                    alert(`Error: ${error.message}`);
                });
        }
        // Function to hide the modal
        function closeInsertSubscriberModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
        }


        // API calls
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        async function loadSectionData(section) {
            switch (section) {
                case 'subscribers':
                    const subscribers = await fetchData('subscribers');
                    renderSubscribers(subscribers);  // Call renderSubscribers
                    break;
                case 'documents':
                    const documents = await fetchData('documents');
                    fetchDocuments(1);  // Fetch the first page of documents

                    renderDocuments(documents);
                    break;
                case 'loans':
                    const loans = await fetchData('loans');
                    renderLoans(loans);
                    break;
            }
        }

        // Render documents to the table
        function renderDocuments(documents) {
            const documentsTable = document.getElementById('documentsList');
            // fetchDocuments(1);
            documentsTable.innerHTML = '';  // Clear existing data

            documents.forEach(doc => {
                const row = document.createElement('tr');

                const titleCell = document.createElement('td');
                titleCell.textContent = doc.title;  // Replace with actual document properties
                row.appendChild(titleCell);

                const authorCell = document.createElement('td');
                authorCell.textContent = doc.author;  // Replace with actual document properties
                row.appendChild(authorCell);

                const typeCell = document.createElement('td');
                typeCell.textContent = doc.type;  // Replace with actual document properties
                row.appendChild(typeCell);

                const availabilityCell = document.createElement('td');
                availabilityCell.textContent = doc.availability;  // Replace with actual document properties
                row.appendChild(availabilityCell);

                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `<button class="btn btn-primary">Edit</button>`;  // Add actions as needed
                row.appendChild(actionsCell);

                documentsTable.appendChild(row);
            });
        }
        // Function to render pagination controls
        function renderPagination(currentPage, totalDocuments, perPage) {
            const totalPages = Math.ceil(totalDocuments / perPage);
            const paginationContainer = document.getElementById('pagination');

            paginationContainer.innerHTML = ''; // Clear existing pagination

            // Create previous page button
            if (currentPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'Previous';
                prevButton.onclick = () => fetchDocuments(currentPage - 1);
                paginationContainer.appendChild(prevButton);
            }

            // Create page buttons
            for (let page = 1; page <= totalPages; page++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = page;
                pageButton.onclick = () => fetchDocuments(page);
                if (page === currentPage) {
                    pageButton.disabled = true; // Disable the current page button
                }
                paginationContainer.appendChild(pageButton);
            }

            // Create next page button
            if (currentPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = 'Next';
                nextButton.onclick = () => fetchDocuments(currentPage + 1);
                paginationContainer.appendChild(nextButton);
            }
        }

        function updatePaginationButtons(documentsData) {
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');

            // Disable prev button on the first page
            prevButton.disabled = documentsData.current_page === 1;

            // Disable next button on the last page
            nextButton.disabled = documentsData.current_page === documentsData.total_pages;
        }

        // Function to fetch documents with pagination
        async function fetchDocuments(page) {
            try {
                const perPage = 10;  // Number of documents per page
                const response = await fetch(`/api/documents/?page=${page}&per_page=${perPage}`);
                const data = await response.json();

                if (data.documents && Array.isArray(data.documents)) {
                    renderDocuments(data.documents);
                    renderPagination(data.pagination.page, data.pagination.total_documents, data.pagination.per_page);
                } else {
                    console.error('Invalid data format for documents:', data);
                }
            } catch (error) {
                console.error('Error fetching documents:', error);
            }
        }
        // Call this to load the first page on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchDocuments(1, 10);  // Load first page with 10 documents per page
        });


        // Render Subscribers data
        function renderSubscribers(subscribers) {
            const subscribersList = document.getElementById('subscribersList');
            subscribersList.innerHTML = '';  // Clear existing content

            if (subscribers && subscribers.length > 0) {
                subscribers.forEach(subscriber => {
                    const row = document.createElement('tr');

                    const nameCell = document.createElement('td');
                    nameCell.classList.add('p-2');
                    nameCell.textContent = subscriber.first_name;
                    row.appendChild(nameCell);

                    const firstNameCell = document.createElement('td');
                    firstNameCell.classList.add('p-2');
                    firstNameCell.textContent = subscriber.last_name;
                    row.appendChild(firstNameCell);

                    const lastNameCell = document.createElement('td');
                    lastNameCell.classList.add('p-2');
                    lastNameCell.textContent = subscriber.phone;
                    row.appendChild(lastNameCell);

                    const emailCell = document.createElement('td');
                    emailCell.classList.add('p-2');
                    emailCell.textContent = subscriber.email;
                    row.appendChild(emailCell);

                    const actionsCell = document.createElement('td');
                    actionsCell.classList.add('p-2');
                    actionsCell.innerHTML = `
                <button onclick="openEditModal('${subscriber._id}')" class="bg-yellow-500 text-white px-4 py-2 rounded">Edit</button>
                <button class="bg-red-500 text-white px-4 py-2 rounded" onclick="deleteSubscriber('${subscriber._id}')">Delete</button>
                <button onclick="showSubscriberDetails(${JSON.stringify(subscriber).replace(/"/g, '&quot;')})" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Details
                </button>
            `;
                    row.appendChild(actionsCell);

                    subscribersList.appendChild(row);
                });
            } else {
                subscribersList.innerHTML = '<tr><td colspan="4" class="p-2 text-center">No subscribers found</td></tr>';
            }
        }


        // Function to display subscriber details
        function showSubscriberDetails(subscriber) {
            const modal = document.getElementById('subscriberDetailsModal');
            const content = document.getElementById('subscriberDetailsContent');

            // Format the current loans into a readable format
            let currentLoansHtml = '';
            subscriber.current_loans.forEach(loan => {
                currentLoansHtml += `
            <div class="border-b py-2">
                <p><strong>Document ID:</strong> ${loan.document_id}</p>
                <p><strong>Loan Date:</strong> ${new Date(loan.loan_date).toLocaleString()}</p>
                <p><strong>Due Date:</strong> ${new Date(loan.due_date).toLocaleString()}</p>
                <p><strong>Status:</strong> ${loan.status}</p>
            </div>
        `;
            });

            // Populate the modal with subscriber details
            content.innerHTML = `
        <p><strong>Nom:</strong> ${subscriber.last_name}</p>
        <p><strong>Prénom:</strong> ${subscriber.first_name}</p>
        <p><strong>Email:</strong> ${subscriber.email}</p>
        <p><strong>Adresse:</strong> ${subscriber.address}</p>
        <p><strong>Téléphone:</strong> ${subscriber.phone}</p>
        <p><strong>Date d'inscription:</strong> ${new Date(subscriber.inscription_date).toLocaleDateString()}</p>
        
        <h4 class="font-bold mt-4">Emprunts Actuels:</h4>
        ${currentLoansHtml ? currentLoansHtml : '<p>Aucun emprunt actuel.</p>'}
        
        <h4 class="font-bold mt-4">Historique des Emprunts:</h4>
        ${subscriber.loan_history.length > 0 ? subscriber.loan_history.map(loan => {
                return `
                <div class="border-b py-2">
                    <p><strong>Document ID:</strong> ${loan.document_id}</p>
                    <p><strong>Loan Date:</strong> ${new Date(loan.loan_date).toLocaleString()}</p>
                    <p><strong>Due Date:</strong> ${new Date(loan.due_date).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${loan.status}</p>
                </div>
            `;
            }).join('') : '<p>Aucun historique d\'emprunts.</p>'}
    `;

            // Show the modal
            modal.classList.remove('hidden');
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById('subscriberDetailsModal');
            modal.classList.add('hidden');
        }

        function deleteSubscriber(subscriberId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Perform the delete request
                    fetch(`/api/subscribers/${subscriberId}`, {
                        method: 'DELETE',
                    })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire(
                                    'Deleted!',
                                    'The subscriber has been deleted.',
                                    'success'
                                );
                                fetchSubscribers(); // Refresh the list after deletion
                            } else {
                                response.json().then(data => {
                                    Swal.fire(
                                        'Error!',
                                        data.message || 'Failed to delete the subscriber.',
                                        'error'
                                    );
                                });
                            }
                        })
                        .catch(error => {
                            console.error("Error deleting subscriber:", error);
                            Swal.fire(
                                'Error!',
                                'An error occurred while deleting the subscriber.',
                                'error'
                            );
                        });
                }
            });
        }


        function fetchSubscribers() {
            fetch('/api/subscribers/')
                .then(response => response.json())
                .then(data => {
                    renderSubscribers(data);
                })
                .catch(error => {
                    console.error("Error fetching subscribers:", error);
                    alert("Failed to load subscribers");
                });
        }


        function openEditModal(id) {
            console.log(`Opening edit modal for subscriber ID: ${id}`);

            // Fetch subscriber details by ID
            fetch(`/api/subscribers/${id}`)
                .then(response => response.json())
                .then(subscriber => {
                    console.log('Subscriber data:', subscriber);

                    // Show the modal
                    const modal = document.getElementById('editModal');
                    modal.style.display = 'block'; // Ensure this works
                    console.log('Modal display set to block');

                    // Populate the form with subscriber data
                    document.getElementById('editFirstName').value = subscriber.first_name;
                    document.getElementById('editLastName').value = subscriber.last_name;
                    document.getElementById('editEmail').value = subscriber.email;
                    document.getElementById('editAddress').value = subscriber.address;
                    document.getElementById('editPhone').value = subscriber.phone;

                    console.log('Form fields populated');

                    // Attach event listener to the "Edit" button
                    const editButton = document.getElementById('editSubscriberButton');
                    editButton.onclick = function () {
                        const updatedSubscriber = {
                            first_name: document.getElementById('editFirstName').value,
                            last_name: document.getElementById('editLastName').value,
                            email: document.getElementById('editEmail').value,
                            address: document.getElementById('editAddress').value,
                            phone: document.getElementById('editPhone').value,
                        };
                        fetch(`/api/subscribers/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedSubscriber),
                        })
                            .then(response => response.json())
                            .then(data => {
                                Swal.fire({
                                    title: 'Success!',
                                    text: 'Subscriber updated successfully.',
                                    icon: 'success',
                                    timer: 3000,
                                    timerProgressBar: true,
                                });
                                // Close modal and reload subscribers list
                                modal.style.display = 'none';
                                fetchSubscribers();
                            })
                            .catch(error => {
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'Failed to update subscriber.',
                                    icon: 'error',
                                });
                                console.error('Error updating subscriber:', error);
                            });
                    };
                })
                .catch(error => {
                    console.error('Error fetching subscriber:', error);
                });
        }


        // Close modal on Cancel
        function closeEditSubscribeModal() {
            const modal = document.getElementById('editModal');
            modal.style.display = 'none';
        }


        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            showSection('subscribers');
        });
    </script>
</body>

</html>