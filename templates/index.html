<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Médiathèque - Gestion des Abonnés</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Médiathèque</h1>
            <div class="space-x-4">
                <a href="#" class="hover:text-gray-200" onclick="showSection('subscribers')">Abonnés</a>
                <a href="#" class="hover:text-gray-200" onclick="showSection('documents')">Documents</a>
                <a href="#" class="hover:text-gray-200" onclick="showSection('loans')">Emprunts</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <!-- Subscribers Section -->
        <section id="subscribers" class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Abonnés</h2>
                <button onclick="showModal('subscriberForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouvel Abonné
                </button>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">First Name</th>
                            <th class="text-left p-2">Last Name</th>
                            <th class="text-left p-2">Role</th>
                            <th class="text-left p-2">phone</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subscribersList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Documents Section -->
        <section id="documents" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Documents</h2>
                <button onclick="showModal('documentForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouveau Document
                </button>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">Titre</th>
                            <th class="text-left p-2">Auteur</th>
                            <th class="text-left p-2">Type</th>
                            <th class="text-left p-2">Disponibilité</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Loans Section -->
        <section id="loans" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Gestion des Emprunts</h2>
                <button onclick="showModal('loanForm')" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Nouvel Emprunt
                </button>
            </div>
            <div class="bg-white shadow rounded-lg p-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">Abonné</th>
                            <th class="text-left p-2">Document</th>
                            <th class="text-left p-2">Date d'emprunt</th>
                            <th class="text-left p-2">Date de retour</th>
                            <th class="text-left p-2">Status</th>
                            <th class="text-left p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loansList">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Modal Templates -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg p-4 max-w-lg mx-auto mt-20">
            <!-- Modal content will be injected here -->
        </div>
    </div>
    <!-- Subscriber Details Modal -->
<!-- Modal content (updated) -->
<div id="subscriberDetailsModal" class="hidden fixed inset-0 z-50 flex justify-center items-center">
    <div class="modal-content bg-white p-4 rounded-md shadow-lg relative">
        <!-- Close button (X) -->
        <button onclick="closeModal()" class="absolute top-2 right-2 text-red-500 text-xl font-bold">&times;</button>

        <!-- Modal content goes here -->
        <div id="subscriberDetailsContent">
            <!-- Dynamic subscriber details will be populated here -->
        </div>
    </div>
</div>



    <script>
        // Utility functions
        function showSection(sectionId) {
            document.querySelectorAll('main section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            loadSectionData(sectionId);
        }

        function showModal(formId) {
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            // Inject appropriate form based on formId
        }

        // API calls
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        async function loadSectionData(section) {
            switch (section) {
                case 'subscribers':
                    const subscribers = await fetchData('subscribers');
                    renderSubscribers(subscribers);  // Call renderSubscribers
                    break;
                case 'documents':
                    const documents = await fetchData('documents');
                    renderDocuments(documents);
                    break;
                case 'loans':
                    const loans = await fetchData('loans');
                    renderLoans(loans);
                    break;
            }
        }


        function renderDocuments(documents) {
            const documentsTable = document.getElementById('documentsList');
            documentsTable.innerHTML = '';

            if (Array.isArray(documents.data)) {
                documents.data.forEach(document => {
                    const row = document.createElement('tr');

                    const titleCell = document.createElement('td');
                    titleCell.textContent = document.title;
                    row.appendChild(titleCell);

                    const authorCell = document.createElement('td');
                    authorCell.textContent = document.author;
                    row.appendChild(authorCell);

                    const typeCell = document.createElement('td');
                    typeCell.textContent = document.type;
                    row.appendChild(typeCell);

                    const availabilityCell = document.createElement('td');
                    availabilityCell.textContent = document.available ? 'Disponible' : 'Indisponible';
                    row.appendChild(availabilityCell);

                    const actionsCell = document.createElement('td');
                    // Add actions for editing and deleting the document
                    row.appendChild(actionsCell);

                    documentsTable.appendChild(row);
                });
            } else {
                console.error('Documents data is not an array:', documents);
            }
        }

        // Render Subscribers data
        function renderSubscribers(subscribers) {
    const subscribersList = document.getElementById('subscribersList');
    subscribersList.innerHTML = '';  // Clear existing content

    if (subscribers && subscribers.length > 0) {
        subscribers.forEach(subscriber => {
            const row = document.createElement('tr');

            const nameCell = document.createElement('td');
            nameCell.classList.add('p-2');
            nameCell.textContent = subscriber.first_name;
            row.appendChild(nameCell);

            const firstNameCell = document.createElement('td');
            firstNameCell.classList.add('p-2');
            firstNameCell.textContent = subscriber.last_name;
            row.appendChild(firstNameCell);

            const lastNameCell = document.createElement('td');
            lastNameCell.classList.add('p-2');
            lastNameCell.textContent = subscriber.phone;
            row.appendChild(lastNameCell);

            const emailCell = document.createElement('td');
            emailCell.classList.add('p-2');
            emailCell.textContent = subscriber.email;
            row.appendChild(emailCell);

            const actionsCell = document.createElement('td');
            actionsCell.classList.add('p-2');
            actionsCell.innerHTML = `
                <button class="bg-yellow-500 text-white px-4 py-2 rounded">Edit</button>
                <button class="bg-red-500 text-white px-4 py-2 rounded">Delete</button>
                <button onclick="showSubscriberDetails(${JSON.stringify(subscriber).replace(/"/g, '&quot;')})" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Voir Détails
                </button>
            `;
            row.appendChild(actionsCell);

            subscribersList.appendChild(row);
        });
    } else {
        subscribersList.innerHTML = '<tr><td colspan="4" class="p-2 text-center">No subscribers found</td></tr>';
    }
}


       // Function to display subscriber details
function showSubscriberDetails(subscriber) {
    const modal = document.getElementById('subscriberDetailsModal');
    const content = document.getElementById('subscriberDetailsContent');

    // Format the current loans into a readable format
    let currentLoansHtml = '';
    subscriber.current_loans.forEach(loan => {
        currentLoansHtml += `
            <div class="border-b py-2">
                <p><strong>Document ID:</strong> ${loan.document_id}</p>
                <p><strong>Loan Date:</strong> ${new Date(loan.loan_date).toLocaleString()}</p>
                <p><strong>Due Date:</strong> ${new Date(loan.due_date).toLocaleString()}</p>
                <p><strong>Status:</strong> ${loan.status}</p>
            </div>
        `;
    });

    // Populate the modal with subscriber details
    content.innerHTML = `
        <p><strong>Nom:</strong> ${subscriber.last_name}</p>
        <p><strong>Prénom:</strong> ${subscriber.first_name}</p>
        <p><strong>Email:</strong> ${subscriber.email}</p>
        <p><strong>Adresse:</strong> ${subscriber.address}</p>
        <p><strong>Téléphone:</strong> ${subscriber.phone}</p>
        <p><strong>Date d'inscription:</strong> ${new Date(subscriber.inscription_date).toLocaleDateString()}</p>
        
        <h4 class="font-bold mt-4">Emprunts Actuels:</h4>
        ${currentLoansHtml ? currentLoansHtml : '<p>Aucun emprunt actuel.</p>'}
        
        <h4 class="font-bold mt-4">Historique des Emprunts:</h4>
        ${subscriber.loan_history.length > 0 ? subscriber.loan_history.map(loan => {
            return `
                <div class="border-b py-2">
                    <p><strong>Document ID:</strong> ${loan.document_id}</p>
                    <p><strong>Loan Date:</strong> ${new Date(loan.loan_date).toLocaleString()}</p>
                    <p><strong>Due Date:</strong> ${new Date(loan.due_date).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${loan.status}</p>
                </div>
            `;
        }).join('') : '<p>Aucun historique d\'emprunts.</p>'}
    `;

    // Show the modal
    modal.classList.remove('hidden');
}

// Function to close the modal
function closeModal() {
    const modal = document.getElementById('subscriberDetailsModal');
    modal.classList.add('hidden');
}



        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            showSection('subscribers');
        });
    </script>
</body>

</html>